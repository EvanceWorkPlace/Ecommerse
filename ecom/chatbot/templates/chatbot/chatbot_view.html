{% extends 'base.html' %}
{% block content %}

<section class="chat-wrapper py-4">
  <div class="container">
    <div class="row g-3 justify-content-center">

      <!-- LEFT INFO PANEL (visible only on md+) -->
      <div class="col-md-4 d-none d-md-flex">
        <div class="info-panel shadow-sm p-4 rounded-4 w-100 bg-white">

          <h3 class="fw-bold mb-3">Your Health Assistant</h3>
          <p class="small text-muted">
            Ask about symptoms and receive safe, concise over-the-counter suggestions.  
            Staff will review before official documents (prescription, sick note) are issued.
          </p>

          <hr>

          <a href="{% url 'my_consultations' %}" class="btn btn-outline-primary w-100 mb-3">
            My Consultations
          </a>

          <div class="text-center small text-muted mt-auto">
            Secure ‚Ä¢ Private ‚Ä¢ Non-diagnostic
          </div>
        </div>
      </div>

      <!-- CHAT PANEL -->
      <div class="col-12 col-md-8">
        <div class="chat-card shadow-sm rounded-4 bg-white d-flex flex-column">

          <!-- HEADER -->
          <div class="chat-header p-3 border-bottom">
            <h5 class="mb-0">Health Assistant üí¨</h5>
            <small class="text-muted">AI-powered medical guidance</small>
          </div>

          <!-- CHAT BODY -->
          <div id="chatBody" class="chat-body p-3 overflow-auto">
            <div class="text-center text-muted mt-3">
              <div class="lead small">
                üëã Hello! Describe your symptoms and I‚Äôll suggest safe OTC options.
              </div>
            </div>
          </div>

          <!-- FOOTER -->
          <div class="chat-footer border-top p-3">
            <form id="chatForm" class="d-flex gap-2">
              {% csrf_token %}
              <input type="text" id="userInput"
                     class="form-control rounded-pill"
                     placeholder="Describe your symptoms..."
                     autocomplete="off" required>
              <button type="submit" id="sendBtn"
                      class="btn btn-primary rounded-pill px-4">
                Send
              </button>
            </form>
          </div>

        </div>
      </div>

    </div>
  </div>
</section>


<!-- ========================= -->
<!--        CHAT SCRIPT        -->
<!-- ========================= -->
<script>
(function() {
  const chatForm = document.getElementById('chatForm');
  const userInput = document.getElementById('userInput');
  const chatBody = document.getElementById('chatBody');
  const sendBtn = document.getElementById('sendBtn');

  function appendHTML(html, side='bot') {
    const wrapper = document.createElement('div');
    wrapper.className = side === 'user'
      ? 'user-message mb-2 text-end'
      : 'bot-message mb-2 text-start';
    wrapper.innerHTML = html;
    chatBody.appendChild(wrapper);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function textBubble(text, cls='') {
    return `<div class="${cls} p-3 rounded-3 shadow-sm">${text}</div>`;
  }

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = userInput.value.trim();
    if (!message) return;

    appendHTML(textBubble(message, "bg-primary text-white"), "user");
    userInput.value = "";
    sendBtn.disabled = true;
    sendBtn.textContent = "Sending...";

    // typing dots
    const typingDiv = document.createElement("div");
    typingDiv.className = "bot-message mb-2";
    typingDiv.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>`;
    chatBody.appendChild(typingDiv);
    chatBody.scrollTop = chatBody.scrollHeight;

    try {
      const response = await fetch("{% url 'chatbot_response' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        },
        body: JSON.stringify({ message })
      });

      const data = await response.json();
      typingDiv.remove();

      if (data.error) {
        appendHTML(textBubble("‚ö†Ô∏è " + data.error, "bg-light text-danger"), "bot");
      } else {
        let replyHTML = `<div>${data.reply}</div>`;
        if (data.consultation_id) {
          replyHTML += `
            <div class="mt-2 small">
              <a class="text-primary" href="/chatbot/consultation/${data.consultation_id}/">
                View consultation
              </a>
            </div>`;
        }
        appendHTML(textBubble(replyHTML, "bg-white border"), "bot");
      }

    } catch (err) {
      typingDiv.remove();
      appendHTML(textBubble("‚ö†Ô∏è Unable to reach server.", "bg-light text-danger"), "bot");
    }

    sendBtn.disabled = false;
    sendBtn.textContent = "Send";
    chatBody.scrollTop = chatBody.scrollHeight;
  });
})();
</script>


<!-- ========================= -->
<!--        STYLE FIXES        -->
<!-- ========================= -->
<style>
/* Prevent chat from filling the entire screen */
.chat-wrapper {
  padding-top: 40px;
  padding-bottom: 40px;
}

/* Chat card height stays proportional ‚Äî DOES NOT BREAK FOOTER */
.chat-card {
  height: 75vh;            /* was 100vh ‚Äî now fixed */
  max-height: 750px;       /* prevents too large */
  display: flex;
  flex-direction: column;
}

/* Scroll area */
.chat-body {
  flex: 1;
  overflow-y: auto;
}

/* Assistant messages */
.bot-message div {
  background: #ffffff;
}

/* User messages */
.user-message div {
  background: linear-gradient(135deg, #2196f3, #0a58ca);
  color: white;
}

/* Typing animation */
.typing-dots span {
  display: inline-block;
  width: 8px;
  height: 8px;
  margin-right: 4px;
  background: #2196f3;
  border-radius: 50%;
  animation: bounce 1s infinite ease-in-out;
}
.typing-dots span:nth-child(2) { animation-delay: .15s }
.typing-dots span:nth-child(3) { animation-delay: .3s }

@keyframes bounce {
  0%, 100% { transform: translateY(0); opacity: .3 }
  50% { transform: translateY(-6px); opacity: 1 }
}

/* Responsive */
@media (max-width: 767px) {
  .chat-card { height: 68vh; }
  .user-message div, .bot-message div { font-size: .95rem; }
}
</style>

{% endblock %}
