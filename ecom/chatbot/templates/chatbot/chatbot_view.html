{% extends 'base.html' %}
{% block content %}

<section class="py-2">
  <!-- Header -->
 

  <!-- Chat Section -->
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
          <div class="card-header bg-primary text-white fw-semibold rounded-top-4">
            Your Health Assistant üí¨
          </div>

          <div class="card-body chat-body" id="chatBody">
            <div class="text-center text-muted mt-3">
              üëã Hello! Tell me your symptoms, and I‚Äôll suggest some safe over-the-counter options.
            </div>
          </div>

          <div class="card-footer bg-light border-0">
            <form id="chatForm" class="d-flex">
              {% csrf_token %}
              <input type="text" id="userInput" class="form-control rounded-pill me-2" placeholder="Describe your symptoms..." required>
              <button type="submit" class="btn btn-blue rounded-pill px-4">Send</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- JavaScript -->
<script>
  const chatForm = document.getElementById('chatForm');
  const userInput = document.getElementById('userInput');
  const chatBody = document.getElementById('chatBody');

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = userInput.value.trim();
    if (!message) return;

    appendMessage('user', message);
    userInput.value = '';

    const typing = document.createElement('div');
    typing.classList.add('bot-message', 'typing');
    typing.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    chatBody.appendChild(typing);
    chatBody.scrollTop = chatBody.scrollHeight;

    try {
      const response = await fetch("{% url 'chatbot_response' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ message })
      });

      const data = await response.json();
      typing.remove();

      if (data.error) {
        appendMessage('bot', `‚ö†Ô∏è ${data.error}`);
      } else if (data.condition) {
        const botReply = `
          <div class="bot-message card shadow-sm p-3 mt-2 border-0">
            <strong>Condition:</strong> ${data.condition}<br>
            <strong>Recommended Medicines:</strong> ${data.recommended_medicines.join(", ")}<br>
            <strong>Dosage:</strong> ${data.dosage_guidance}<br>
            <strong>Advice:</strong> ${data.advice}
          </div>
        `;
        chatBody.innerHTML += botReply;
      } else {
        appendMessage('bot', data.reply || "I didn‚Äôt get that. Please try again.");
      }

      chatBody.scrollTop = chatBody.scrollHeight;
    } catch (error) {
      typing.remove();
      appendMessage('bot', "‚ö†Ô∏è Sorry, I couldn't reach the server.");
    }
  });

  function appendMessage(sender, text) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add(sender === 'user' ? 'user-message' : 'bot-message', 'fade-in');
    msgDiv.textContent = text;
    chatBody.appendChild(msgDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
  }
</script>

<!-- Styling -->
<style>
  .btn-blue {
    background: linear-gradient(135deg, #2196f3, #000000);
    color: #fff;
    border: none;
    font-weight: 600;
    transition: background 0.3s ease, transform 0.2s ease;
  }
  .btn-blue:hover {
    background: linear-gradient(135deg, #000000, #2196f3);
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(33, 150, 243, 0.25);
  }

  .chat-body {
    height: 450px;
    overflow-y: auto;
    background-color: #f8f9fa;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .user-message, .bot-message {
    max-width: 75%;
    padding: 10px 15px;
    border-radius: 20px;
    font-size: 0.95rem;
    line-height: 1.4;
    word-wrap: break-word;
    animation: fadeIn 0.3s ease-in-out;
  }

  .user-message {
    align-self: flex-end;
    background: linear-gradient(135deg, #2196f3, #000000);
    color: white;
    border-bottom-right-radius: 5px;
  }

  .bot-message {
    align-self: flex-start;
    background-color: white;
    border: 1px solid #e9ecef;
    color: #333;
    border-bottom-left-radius: 5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  .typing {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-left: 10px;
  }

  .dot {
    width: 8px;
    height: 8px;
    background: #2196f3;
    border-radius: 50%;
    animation: blink 1.4s infinite both;
  }
  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes blink {
    0%, 80%, 100% { opacity: 0; transform: scale(0.8); }
    40% { opacity: 1; transform: scale(1.1); }
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 768px) {
    .user-message, .bot-message { max-width: 90%; font-size: 0.9rem; }
    .chat-body { height: 400px; }
  }
</style>

{% endblock %}
