{% extends 'base.html' %}
{% block content %}

<!-- Loader Overlay (for data/chart loading) -->
<div id="dashboard-loader">
  <div class="spinner-border text-primary" role="status"></div>
  <span class="mt-3 text-primary fw-semibold">Loading dashboard data...</span>
</div>

<section class="py-5 fade-in" style="background: linear-gradient(135deg, #ffffff, #fafafa);">
  <div class="container">
    <div class="text-center mb-5">
      <h2 class="fw-bold text-rose">Orders Dashboard</h2>
      <p class="text-muted">Manage and visualize customer orders with real-time insights.</p>
      <hr class="w-25 mx-auto border-2 border-dark">
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 justify-content-center mb-5">
      <div class="col-md-4">
        <div class="card shadow-lg border-0 rounded-4 text-center dashboard-card fade-up">
          <div class="card-body py-4">
            <h5 class="fw-bold text-dark">Total Orders</h5>
            <h2 class="fw-bold text-rose mb-3">{{ total_orders }}</h2>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card shadow-lg border-0 rounded-4 text-center dashboard-card fade-up">
          <div class="card-body py-4">
            <h5 class="fw-bold text-dark">Pending Shipments</h5>
            <h2 class="fw-bold text-warning mb-3">{{ not_shipped_count }}</h2>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card shadow-lg border-0 rounded-4 text-center dashboard-card fade-up">
          <div class="card-body py-4">
            <h5 class="fw-bold text-dark">Shipped Orders</h5>
            <h2 class="fw-bold text-success mb-3">{{ shipped_count }}</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- ðŸ“Š Charts Section -->
    <div class="row g-4 mb-5">
      <div class="col-lg-6">
        <div class="card shadow-lg border-0 rounded-4">
          <div class="card-body">
            <h5 class="fw-bold mb-3 text-center text-dark">ðŸ“¦ Orders Status</h5>
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card shadow-lg border-0 rounded-4">
          <div class="card-body">
            <h5 class="fw-bold mb-3 text-center text-dark">ðŸ“ˆ Orders Over Time</h5>
            <canvas id="trendChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Orders Table -->
    <div class="table-responsive shadow-sm rounded-4 bg-white">
      <table class="table table-hover align-middle mb-0">
        <thead class="bg-dark text-white">
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for order in recent_orders %}
          <tr>
            <td><a href="{% url 'orders' order.id %}" class="text-decoration-none fw-semibold text-dark">#{{ order.id }}</a></td>
            <td>{{ order.full_name }}</td>
            <td>R {{ order.amount_paid }}</td>
            <td>
              {% if order.shipped %}
                <span class="badge bg-success rounded-pill">Shipped</span>
              {% else %}
                <span class="badge bg-warning text-dark rounded-pill">Pending</span>
              {% endif %}
            </td>
            <td>{{ order.date_ordered|date:"Y-m-d" }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center text-muted py-3">No recent orders found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Delay chart loading slightly to simulate data loading
  document.addEventListener("DOMContentLoaded", () => {
    const loader = document.getElementById("dashboard-loader");

    setTimeout(() => {
      loader.classList.add("hidden");

      // Pie Chart for Order Status
      const statusCtx = document.getElementById('statusChart');
      new Chart(statusCtx, {
        type: 'pie',
        data: {
          labels: ['Shipped', 'Pending'],
          datasets: [{
            data: [{{ shipped_count }}, {{ not_shipped_count }}],
            backgroundColor: ['#28a745', '#ffc107'],
            borderColor: ['#fff', '#fff'],
            borderWidth: 2
          }]
        },
        options: {
          plugins: { legend: { position: 'bottom' } }
        }
      });

      // Line Chart for Orders Over Time
      const trendCtx = document.getElementById('trendChart');
      new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: {{ chart_labels|safe }},
          datasets: [{
            label: 'Orders',
            data: {{ chart_data|safe }},
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } }
        }
      });

    }, 800); // Loader duration
  });
</script>

<!-- Custom Styling -->
<style>
  .text-rose { color: #007bff; }

  /* Dashboard Loader */
  #dashboard-loader {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.85);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1050;
    transition: opacity 0.6s ease, visibility 0.6s ease;
  }

  #dashboard-loader.hidden {
    opacity: 0;
    visibility: hidden;
  }

  .dashboard-card {
    transition: all 0.3s ease;
  }
  .dashboard-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 8px 20px rgba(0, 123, 255, 0.2);
  }

  .fade-in { animation: fadeIn 1s ease-in-out; }
  .fade-up { animation: fadeUp 1.2s ease-in-out; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(40px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
  }

  a.text-decoration-none:hover {
    color: #007bff;
  }
</style>

{% endblock %}
